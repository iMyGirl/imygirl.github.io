# 写在前面

视频链接<https://www.bilibili.com/video/BV1vK4y1o7jH>

例：docker中创建的项目mysite1

```shell
cd /home/Test-python-decorator/ 
```

# P1-Django介绍

## 组件

- 基本配置文件/路由系统
- 模型层(M)/模版层(T)/视图层(V)
- Cookies和Session
- 分页及发邮件
- Admin管理后台

## 用途

- 网页/微信公众号/微信小程序
- 人工智能平台融合

## 版本

官方网站www.djangoproject.com

中文文档参考网站<yiyibooks.cn>

## 安装

安装Python
服务端可参考[安装Python3.7.5（Ubuntu x86）_CANN社区版安装指南_CANN软件安装指南_附录_华为云 (huaweicloud.com)](https://support.huaweicloud.com/cann503installguide/install_023.html)

```sh
# 安装
pip3 install django=2.1.2
# 检查是否安装成功
pip3 freeze|grep -i 'Django'
# 有输出就说明安装成功
```

离线安装亦可

# P2-项目结构1

## 1. 创建项目

```python
# 当前目录下
django-admin startproject {项目名}  #即创建出对应的项目文件夹
# 例创建 mysite1 项目
django-admin startproject mysite1
```

## 2. 启动服务（测试开发阶段）

- 本地访问
  
  ```python
  # cd到项目文件夹
  cd mysite1
  python3 manage.py runserver # 默认监听8000端口，访问http://127.0.0.1:8000/
  # 更换端口
  python3 manage.py runserver {端口号}
  ```

- 远程访问
  
  > 例访问服务端的docker
  
  - 确保启动的docker与宿主机间有映射，参考[docker如何查看宿主机到容器端口映射 (javamana.com)](https://javamana.com/2022/191/202207090735507043.html)
  
  - 查看映射端口，指定监听端口`python manage.py runserver 0.0.0.0:8000`
    
    `0.0.0.0`表示监听所有地址，参考[【Django】不能通过IP访问Docker容器里的Django服务器_remo0x的博客-CSDN博客](https://blog.csdn.net/White_Idiot/article/details/78177373)
  
  - 访问 {宿主机地址}:{端口}  

```shell
# 启动有映射的docker
docker run -p 3307:3306 --name mysql -v /datebase/mysql/conf:/etc/mysql/conf.d -v /datebase/mysql/logs:/logs -v /datebase/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -d mysql:5.6


# 查看docker的映射端口，得到主机到docker的映射端口为0.0.0.0:3307
docker ps


# docker内启动Django
python manage.py runserver 0.0.0.0:3306
# 访问 localhost:3307
```

首次访问会提示

> Invalid HTTP_HOST header: 'xxx.xx.xxx.xxx:8000'.

 修改`setting.py`文件，将 ALLOWED_HOST = [] 改为 ALLOWED_HOST = ['\*']

参考[解决Invalid HTTP_HOST header: 'xxx.xx.xxx.xxx:8000'. You may need to add 'xxx.xx' to ALLOWED_HOSTS问题_coca丶丶的博客-CSDN博客](https://blog.csdn.net/wangctes/article/details/89052886)

P.S. docker内vim不可用参考[简单解决Docker中的镜像没有vim的问题（同时解决apt-get下载很慢的问题，原始的echo写入国内的源）_一只有点酸的程序员的博客-CSDN博客_docker 镜像没有vim](https://blog.csdn.net/weixin_44598727/article/details/108300731)

## 3. 关闭服务

- 方式一-在runserver启动终端下

`Crl + C`可关闭Django 

- 方式二-在其他终端下

```shell
sudo lsof -i:8000 # 查询Django的进程id
# ps -aux|grep 3306
kill -9 {进程id} #杀死相应进程
```

## 4. 启动常见问题

启动时报错，端口被占用，参照3中方式二，关闭进程

## 5. 项目结构

![企业微信截图_16600503128613.png](C:\Users\chris.tian\Documents\work\django-notebook\imygirl.github.io\pic-bed\企业微信截图_16600503128613.png)

## 6. manage.py

- python3 manage.py runserver 启动服务 

- python3 manage.py startapp 创建应用

- python3 manage.py migrate 数据库迁移

- ...
  
  执行 `python3 manage.py`列出所有Django子命令

## 7. mysite1/mysite1（项目同名文件夹）

- \__init\__: Python的初始化文件

- wsgj.py: Web服务网关的配置文件

- urls.py: 项目的主路由配置

- settings.py: 项目的配置文件

# P3-项目结构2

## 1. settings.py

- settings.py包含了Django项目启动的所有配置项

- 配置项分为 公有配置 和 私有配置

- 配置项格式例： BASE_DIR = 'xxxx'

- 公有配置-Django官方提供的基础配置
  
  https://docs.djangoproject.com/en/2.2/ref/settings/

## 2. 公有配置

解读见注释

```python
"""
Django settings for mysite1 project.

Generated by 'django-admin startproject' using Django 2.2.12.

For more information on this file, see
https://docs.djangoproject.com/en/2.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/2.2/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)

# 项目绝对路径
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# /home/Test-python-decorator/mysite1/mysite1/settings.py
#print(os.path.abspath(__file__))
# /home/Test-python-decorator/mysite1/mysite1
#print(os.path.dirname(os.path.abspath(__file__)))




# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/2.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 's%yfa31+m-+jm6#^)psur+un)!93vw&9np!)55a(klfx=*0=+8'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True
#启动模式
#True - 调试模式
#1, 检测代码改动后立刻重启服务
#2，报错页面
# False - 正式启动模式 / 上线模式

# 请求头Host头
ALLOWED_HOSTS = ['10.9.114.21']


# Application definition
# 应用
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
# 中间件
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
# 表明主路由的位置
ROOT_URLCONF = 'mysite1.urls'
# 模板
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'mysite1.wsgi.application'


# Database
# https://docs.djangoproject.com/en/2.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/2.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/2.2/topics/i18n/
# 语言
LANGUAGE_CODE = 'zh-Hans'
# 时区
TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/2.2/howto/static-files/

STATIC_URL = '/static/'
```

- BASE_DIR-绑定项目的绝对路径

- DEBUG-选择开发模式

- ALLOWED_HOSTS-允许访问项目的host头值

- ...

## 3. 自定义配置

- 大写，避免覆盖掉公有配置

# P4-URL和视图函数

## 1. URL

- 定义-统一资源定位符 Uniform Resource Locator

- 作用-表示互联网上某个资源的地址

- URL的一般语法格式
  
  - protocol :// hostname[:port] / path[?query][#fragment]
  
  - 协议：//ip [端口] / 路由 / 查询 / 锚点
    
    - protocol（协议）http/https/file
    
    - hostname（主机名） DNS主机名或域名 或 ip地址
    
    - port（端口号） 默认80
    
    - path（路由地址）“/”隔开的字符串
    
    - query（查询）"?"+查询字符串（key=value）
    
    - fragment（信息片断）"#" + 字符串  - 定位到某一片断

## 2. Django如何处理URL请求

- 根据setting.py中`ROOT_URLCONF`找到主路由文件；默认情况下在urls.py，列表`urlpatterns`中应有此配置，进行匹配，匹配成功即调用`视图函数`，匹配不成功报404
  
  - **视图函数**接受http请求，返回相应内容给浏览器
    
    > def xxx_view(request[,其他参数])：
    >     ...   
    > return HttpResponse对象
  
  <项目同名文件夹下>/views.py
  
  ```python
  from django.http import HttpResponse
  
  def page_2003_view(request):
  
      html = '\<h1>这是第一个页面\</h1>'
      return HttpResponse(html)
  ```

# P5 路由配置1

### 路由配置-path

- path()函数

- 导入

- 语法-path(route, views, name=None)

- 参数：
  
  - route:
  
  - views:
  
  - name：为地址起别名
    
    练习-

# P19 ORM-查询操作-1

- 通过MyModel.objects管理器方法调用查询

| 方法            | 说明            | 用法                                 | sql等同                     | 返回值           |
| ------------- | ------------- | ---------------------------------- | ------------------------- | ------------- |
| all()         | 查询全部记录        | MyModel.objects.all()              | SELECT * FROM tabel       | QuerySet（类数组） |
| get()         | 查询符合条件的单一记录   |                                    |                           |               |
| filter()      | 查询符合条件的多条记录   |                                    |                           |               |
| exclude()     | 查询符合条件之外的全部记录 |                                    |                           |               |
| values()      |               | MyModel.objects.values()           | SELECT 列名1，列名2 FROM tabel | QuerySet(字典)  |
| values_list() |               | MyModel.objects.values_list()      | SELECT 列名1，列名2 FROM tabel | QuerySet(元组)  |
| order_by()    |               | MyModel.objects.order_by('-列'，'列') |                           |               |

-----------------

https://www.bilibili.com/video/BV1NL41157ph?spm_id_from=333.337.search-card.all.click

# ORM

- 数据库操作

     - mysql数据库 + pymysql

     - ORM框架

- 创建、修改、删除表【无法创建数据库】

- 操作表中的数据（不用写sql）

## Django连接数据库
